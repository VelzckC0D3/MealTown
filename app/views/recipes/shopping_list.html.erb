<%= turbo_frame_tag "shopping_modal" do %>
  <div class="shopping_modal_cont">
    <div class="shopping_modal">
      <h1>Hello World</h1>
      <%# Dropdown to select inventory ID %>
      <%= form_with url: user_recipe_shopping_list_path, class: 'form', method: :get do |form| %>
        <%= form.hidden_field :recipe_id, value: params[:recipe_id] %>
        <div class="field">
          <%= form.label :inventory_id, 'Select Inventory:' %>
        </div>
        <div class="field">
          <%= form.collection_select(:inventory_id, @inventory, :id, :name, prompt: true) %>
        </div class="field">
        <div>
          <%= form.submit 'Generate', class: 'submit-btn', data: { turbo: false } %>
        </div class="field">
      <% end %>
      <% if @inventory.present? %>
        <% @selected_inventory = @inventory.find_by(id: params[:inventory_id]) %>
        <% if @selected_inventory %>
          <% @inventory_food = @selected_inventory.food_inventories.map(&:food).compact.sort_by(&:id) %>
          <% @recipe_food = @recipe.recipe_food.map(&:food).compact.sort_by(&:id) %>
          <% common_length = [@inventory_food.length, @recipe_food.length].min %>
          <% difference = @inventory_food.zip(@recipe_food).count do |a, b| a&.id != nil && b&.id != nil && a.id != b.id end %>
          <p>Amount of food to buy: <%= difference %></p>
          <p>Inventory: <%= @selected_inventory.name %></p>
          <p>Recipe: <%= @recipe.name %></p>
          <style>
            .shopping_modal { max-width: 100%; height: 100%; }
            .form { display: none; }
          </style>
        </br>
      </br>
    </br>
    <% @recipe_food_id = @recipe.recipe_food.map {|recipe_food| recipe_food.food_id} %>
    <% @recipe_prices = @recipe.recipe_food.map {|recipe_food| recipe_food.food.price} %>
    <% @recipe_quantities = @recipe.recipe_food.map {|recipe_food| recipe_food.quantity} %>
    <% @recipe_total = @recipe_prices.zip(@recipe_quantities).map {|a, b| a * b} %>
    <% @inventory_food_id = @selected_inventory.food_inventories.map {|food_inventory| food_inventory.food_id} %>
    <% @inventory_prices = @selected_inventory.food_inventories.map {|food_inventory| food_inventory.food.price} %>
    <% @inventory_quantities = @selected_inventory.food_inventories.map {|food_inventory| food_inventory.quantity} %>
    <% @inventory_total = @inventory_prices.zip(@inventory_quantities).map {|a, b| a * b} %>
    <table>
      <tr>
        <th>Food</th>
        <th>Missing Amount</th>
        <th>Total</th>
      </tr>
      <% total_difference = 0 %>
      <% @recipe_food.each_with_index do |recipe_item, index| %>
        <% inventory_item = @selected_inventory.food_inventories.find { |item| item.food_id == recipe_item.id } %>
        <% recipe_price = @recipe_prices[index] * @recipe_quantities[index] %>
        <% if inventory_item.nil? %>
          <% inventory_price = 0 %>
          <% quantity = @recipe_quantities[index] %>
          <% difference = recipe_price %>
        <% else %>
          <% inventory_price = @inventory_prices[index] * inventory_item.quantity %>
          <% quantity = @recipe_quantities[index] - inventory_item.quantity %>
          <% difference = recipe_price - inventory_price %>
        <% end %>
        <% quantity = [quantity, 0].max %>
        <% difference = [difference, 0].max %>
        <% total_difference += difference %>
        <tr>
          <td><%= recipe_item.name %></td>
          <td><%= "#{quantity} #{recipe_item.measurement_unit}" %></td>
          <td><%= "$#{difference}" %></td>
        </tr>
      <% end %>
      <tr>
        <td colspan="2"><strong>Total Cost</strong></td>
        <td><strong><%= "$#{total_difference}" %></strong></td>
      </tr>
    </table>
    <style>
      table { border-collapse: collapse; width: 100%; margin-bottom: 20px }
      th, td { border: 1px solid #dddddd; text-align: left; padding: 8px; background-color: #f2f2f2 }
      th { background-color: #f2f2f2 }
      tr:nth-child(even) { background-color: #f2f2f2 }
      td:hover { background-color: #ffffff }
    </style>
    <!-- table with the food name, quantity and price -->
  <% else %>
    <%= link_to 'Close Modal', :back, data: {controller: "shopping_modal", action: "close_modal" } %>
  <% end %>
<% else %>
  <p>No inventories available.</p>
<% end %>
</div>
</div>
<% end %>
